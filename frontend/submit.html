<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Soumettre — Vuny Leak V2</title>
<link rel="icon" href="assets/favicon.ico">
<link rel="stylesheet" href="css/main.css">
<style>
.submit-layout {
  display:grid; grid-template-columns:1fr 310px; gap:1.2rem;
  max-width:1080px; margin:0 auto; padding:0 1.5rem 3rem;
}
@media(max-width:900px){ .submit-layout { grid-template-columns:1fr; } }

.form-card {
  background:var(--bg2); border:1px solid var(--border);
  border-radius:var(--radius-lg); margin-bottom:1rem; overflow:hidden;
}
.form-card-head {
  display:flex; align-items:center; gap:9px;
  padding:.9rem 1.2rem; border-bottom:1px solid var(--border);
  background:var(--bg3);
}
.form-card-num {
  width:24px; height:24px; border-radius:50%;
  background:var(--red); color:#fff;
  font-size:0.72rem; font-weight:700;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
}
.form-card-title { font-size:0.85rem; font-weight:700; color:var(--white); }
.form-card-body { padding:1.1rem; }

.type-toggle { display:grid; grid-template-columns:1fr 1fr; gap:7px; }
.type-btn {
  padding:11px; border-radius:var(--radius); font-size:0.8rem; font-weight:700;
  border:1px solid var(--border); background:var(--bg3); color:var(--text-muted);
  cursor:pointer; transition:all 0.15s; text-align:center;
}
.type-btn.sel-free { border-color:rgba(34,197,94,0.5); color:var(--green); background:rgba(34,197,94,0.1); }
.type-btn.sel-paid { border-color:rgba(232,37,58,0.5); color:var(--red); background:var(--red-dim); }

.cat-grid { display:grid; grid-template-columns:1fr 1fr; gap:4px; }
.cat-btn {
  padding:6px 8px; border-radius:var(--radius); font-size:0.73rem; font-weight:500;
  border:1px solid var(--border); background:var(--bg3); color:var(--text-muted);
  cursor:pointer; transition:all 0.12s; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.cat-btn.selected { border-color:rgba(232,37,58,0.5); color:var(--red); background:var(--red-dim); }

/* Image upload zone */
.img-upload-zone {
  border:2px dashed var(--border2); border-radius:var(--radius-lg);
  background:var(--bg3); padding:1.5rem 1rem;
  text-align:center; cursor:pointer; transition:all 0.15s;
  position:relative;
}
.img-upload-zone:hover, .img-upload-zone.dragover {
  border-color:var(--red); background:var(--red-dim);
}
.img-upload-zone input[type=file] {
  position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%;
}
.img-upload-icon { width:32px; height:32px; color:var(--text-dim); margin:0 auto .5rem; transition:color 0.15s; }
.img-upload-zone:hover .img-upload-icon, .img-upload-zone.dragover .img-upload-icon { color:var(--red); }
.img-upload-text { font-size:0.8rem; color:var(--text-muted); }
.img-upload-sub { font-size:0.7rem; color:var(--text-dim); margin-top:2px; }

.images-preview { display:grid; grid-template-columns:repeat(3,1fr); gap:5px; margin-top:.7rem; }
.img-slot {
  aspect-ratio:16/9; border-radius:6px; overflow:hidden;
  background:var(--bg4); border:1px solid var(--border); position:relative;
  display:flex; align-items:center; justify-content:center;
}
.img-slot img { width:100%; height:100%; object-fit:cover; }
.img-slot:first-child::after {
  content:'MINIATURE'; position:absolute; bottom:0; left:0; right:0;
  background:rgba(232,37,58,0.8); color:#fff; font-size:0.55rem; font-weight:700;
  letter-spacing:0.1em; text-align:center; padding:2px;
}
.rm-img {
  position:absolute; top:3px; right:3px;
  background:rgba(0,0,0,0.8); color:#fff; border:none;
  border-radius:50%; width:18px; height:18px; font-size:0.6rem;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  opacity:0; transition:opacity 0.15s;
}
.img-slot:hover .rm-img { opacity:1; }

/* File section */
.file-tabs { display:flex; gap:5px; margin-bottom:.9rem; }
.file-tab {
  padding:6px 14px; border-radius:var(--radius); font-size:0.78rem; font-weight:600;
  border:1px solid var(--border); background:var(--bg3); color:var(--text-muted);
  cursor:pointer; transition:all 0.12s;
}
.file-tab.active { border-color:rgba(232,37,58,0.5); color:var(--red); background:var(--red-dim); }

.file-panel { display:none; }
.file-panel.active { display:block; }

.file-row {
  display:flex; align-items:center; gap:7px;
  background:var(--bg3); border:1px solid var(--border);
  border-radius:var(--radius); padding:8px 11px; margin-bottom:5px;
}
.file-row svg { color:var(--text-dim); flex-shrink:0; width:13px; height:13px; }
.file-row input { flex:1; background:none; color:var(--text); font-size:0.8rem; min-width:0; }
.rm-file { background:none; color:var(--text-dim); border:none; cursor:pointer; font-size:0.8rem; flex-shrink:0; transition:color 0.12s; }
.rm-file:hover { color:var(--red); }

/* File upload zone */
.file-upload-zone {
  border:2px dashed var(--border2); border-radius:var(--radius);
  background:var(--bg3); padding:1.2rem; text-align:center;
  cursor:pointer; transition:all 0.15s; position:relative;
}
.file-upload-zone:hover, .file-upload-zone.dragover { border-color:var(--red); background:var(--red-dim); }
.file-upload-zone input[type=file] {
  position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%;
}
.uploaded-file-row {
  display:flex; align-items:center; justify-content:space-between; gap:7px;
  background:var(--bg3); border:1px solid rgba(34,197,94,0.3);
  border-radius:var(--radius); padding:7px 11px; margin-bottom:5px;
}
.uploaded-file-info { display:flex; align-items:center; gap:7px; min-width:0; }
.uploaded-file-name { font-size:0.78rem; color:var(--white); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.uploaded-file-size { font-size:0.7rem; color:var(--text-dim); flex-shrink:0; }

.warning-box {
  display:flex; align-items:flex-start; gap:9px;
  background:rgba(245,158,11,0.08); border:1px solid rgba(245,158,11,0.25);
  border-radius:var(--radius); padding:10px 13px;
  font-size:0.78rem; color:var(--yellow); margin-bottom:1.2rem;
}
.warning-box svg { flex-shrink:0; width:14px; height:14px; margin-top:1px; }

/* Submit btn */
.submit-btn-wrap { display:flex; flex-direction:column; gap:7px; margin-top:.5rem; }
</style>
</head>
<body>

<header class="navbar" id="navbar"></header>
<nav class="mobile-nav" id="mobileNav">
  <a href="index.html">Accueil</a>
  <a href="shop.html">Boutique</a>
  <a href="downloads.html">Téléchargements</a>
  <a href="about.html">À propos</a>
</nav>

<div class="page-wrap">
  <div style="max-width:1080px;margin:2rem auto 1rem;padding:0 1.5rem">
    <a href="index.html" style="font-size:0.78rem;color:var(--text-muted);display:inline-flex;align-items:center;gap:5px;margin-bottom:1rem;transition:color 0.12s"
      onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--text-muted)'">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
      Retour
    </a>
    <h1 style="font-family:var(--font-display);font-size:2rem;color:var(--white);margin-bottom:.2rem;letter-spacing:0.03em">SOUMETTRE UNE <span style="color:var(--red)">RESSOURCE</span></h1>
    <p style="color:var(--text-muted);font-size:0.83rem;margin-bottom:1.2rem">Partagez vos créations avec la communauté. Vérification par notre équipe avant publication.</p>
    <div class="warning-box">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      Respectez les règles : ne soumettez pas des ressources payantes comme gratuites. Tout contenu frauduleux entraîne un ban.
    </div>
  </div>

  <div class="submit-layout">
    <!-- GAUCHE -->
    <div>
      <!-- 1. INFOS -->
      <div class="form-card">
        <div class="form-card-head">
          <div class="form-card-num">1</div>
          <div class="form-card-title">Informations générales</div>
        </div>
        <div class="form-card-body">
          <div class="form-group">
            <label class="form-label">Titre <span class="req">*</span></label>
            <input class="form-input" id="fTitle" maxlength="180" placeholder="Ex : Script Admin Panel V2, Custom MLO..."
              oninput="document.getElementById('charCount').textContent=this.value.length+'/180'">
            <div class="form-help" id="charCount">0/180</div>
          </div>
          <div class="form-group">
            <label class="form-label">Description <span class="req">*</span></label>
            <textarea class="form-input" id="fDesc" style="min-height:130px"
              placeholder="Fonctionnalités, compatibilité, instructions d'installation..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Vidéo de présentation
              <span style="font-weight:400;color:var(--text-dim)"> — optionnel</span>
            </label>
            <input class="form-input" id="fVideo" placeholder="https://youtube.com/watch?v=...">
          </div>
        </div>
      </div>

      <!-- 2. FICHIERS -->
      <div class="form-card">
        <div class="form-card-head">
          <div class="form-card-num">2</div>
          <div class="form-card-title">Fichiers <span id="fileCountLabel" style="color:var(--text-dim);font-weight:400;font-size:0.75rem">(0)</span></div>
        </div>
        <div class="form-card-body">
          <div class="file-tabs">
            <button class="file-tab active" id="tabLink" onclick="switchFileTab('link')">
              <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="display:inline;vertical-align:middle;margin-right:4px"><path d="m10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="m14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
              Lien URL
            </button>
            <button class="file-tab" id="tabUpload" onclick="switchFileTab('upload')">
              <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="display:inline;vertical-align:middle;margin-right:4px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Upload fichier
            </button>
          </div>

          <!-- Panel liens -->
          <div class="file-panel active" id="panelLink">
            <div id="fileList"></div>
            <button class="btn btn-ghost btn-sm" style="width:100%;border:1px dashed var(--border);margin-top:5px" onclick="addFile()">
              <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Ajouter un lien
            </button>
          </div>

          <!-- Panel upload -->
          <div class="file-panel" id="panelUpload">
            <div id="uploadedFileList"></div>
            <div class="file-upload-zone" id="fileDropZone"
              ondragover="e=>{e.preventDefault();this.classList.add('dragover')}"
              ondragleave="document.getElementById('fileDropZone').classList.remove('dragover')"
              ondrop="handleFileDrop(event,'file')">
              <input type="file" multiple accept=".zip,.rar,.7z,.lua,.js,.json,.sql,.cfg,.ytd,.ydr,.yft,.ymap,.ytyp" onchange="handleFileSelect(event)">
              <svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="margin:0 auto .5rem;color:var(--text-dim)">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <div style="font-size:0.8rem;color:var(--text-muted)">Glissez vos fichiers ici</div>
              <div style="font-size:0.7rem;color:var(--text-dim);margin-top:2px">.zip .rar .7z .lua et plus — ou cliquez pour choisir</div>
            </div>
            <p style="font-size:0.7rem;color:var(--text-dim);margin-top:.5rem">
              ⚠️ L'upload de fichiers nécessite une configuration serveur (multer). Utilisez des liens si non configuré.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- DROITE -->
    <div>
      <!-- 3. IMAGES -->
      <div class="form-card">
        <div class="form-card-head">
          <div class="form-card-num">3</div>
          <div class="form-card-title">Images <span id="imgCountLabel" style="color:var(--text-dim);font-weight:400;font-size:0.73rem">(0/10)</span></div>
        </div>
        <div class="form-card-body">
          <p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:.7rem">La 1ère image = miniature principale.</p>

          <!-- Drag & drop images -->
          <div class="img-upload-zone" id="imgDropZone"
            ondragover="event.preventDefault();document.getElementById('imgDropZone').classList.add('dragover')"
            ondragleave="document.getElementById('imgDropZone').classList.remove('dragover')"
            ondrop="handleFileDrop(event,'image')">
            <input type="file" multiple accept="image/*" id="imgFileInput" onchange="handleImageSelect(event)">
            <svg class="img-upload-icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            <div class="img-upload-text">Glissez vos images ou cliquez</div>
            <div class="img-upload-sub">JPG, PNG, WebP — max 10 images</div>
          </div>

          <!-- URL input alternative -->
          <div style="display:flex;align-items:center;gap:7px;margin:.7rem 0">
            <div style="flex:1;height:1px;background:var(--border)"></div>
            <span style="font-size:0.7rem;color:var(--text-dim)">ou URL</span>
            <div style="flex:1;height:1px;background:var(--border)"></div>
          </div>
          <div style="display:flex;gap:6px">
            <input class="form-input" id="imgUrlInput" placeholder="https://..." style="flex:1;font-size:0.78rem;padding:7px 10px">
            <button class="btn btn-outline btn-sm" onclick="addImgUrl()">Ajouter</button>
          </div>

          <div class="images-preview" id="imagesPreview" style="margin-top:.8rem"></div>
        </div>
      </div>

      <!-- 4. TYPE -->
      <div class="form-card">
        <div class="form-card-head">
          <div class="form-card-num">4</div>
          <div class="form-card-title">Type</div>
        </div>
        <div class="form-card-body">
          <div class="type-toggle" style="margin-bottom:.9rem">
            <button class="type-btn sel-free" id="btnFree" onclick="setType('free')">GRATUITE</button>
            <button class="type-btn" id="btnPaid" onclick="setType('paid')">PAYANTE</button>
          </div>
          <div id="paidSection" style="display:none">
            <div class="form-group">
              <label class="form-label">Lien d'achat <span class="req">*</span></label>
              <input class="form-input" id="fPurchaseUrl" placeholder="https://...">
            </div>
            <div class="form-group">
              <label class="form-label">Prix (EUR) <span class="req">*</span></label>
              <input class="form-input" id="fPrice" type="number" min="0" step="0.01" placeholder="9.99">
            </div>
          </div>
          <!-- VIP TOGGLE — admins uniquement -->
          <div id="vipToggleSection" style="display:none;margin-top:.8rem">
            <div style="background:var(--red-dim);border:1px solid var(--red-border);border-radius:var(--radius);padding:.8rem 1rem">
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none">
                <div class="vip-toggle-wrap" id="vipToggleWrap" onclick="toggleVipOnly()">
                  <div class="vip-toggle-track" id="vipToggleTrack">
                    <div class="vip-toggle-thumb" id="vipToggleThumb"></div>
                  </div>
                </div>
                <div>
                  <div style="font-size:0.85rem;font-weight:600;color:var(--red)">Accès VIP requis</div>
                  <div style="font-size:0.75rem;color:var(--text-dim);margin-top:1px">Cette ressource sera uniquement disponible sur la page VIP</div>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- 5. CATÉGORIE -->
      <div class="form-card">
        <div class="form-card-head">
          <div class="form-card-num">5</div>
          <div class="form-card-title">Catégorie <span class="req">*</span></div>
        </div>
        <div class="form-card-body">
          <div class="cat-grid" id="catGrid"></div>
        </div>
      </div>

      <!-- CONFIRMATION + SUBMIT -->
      <div class="form-card">
        <div class="form-card-body">
          <label style="display:flex;align-items:flex-start;gap:9px;cursor:pointer;font-size:0.78rem;color:var(--text-muted);line-height:1.5">
            <input type="checkbox" id="fAuthor" style="margin-top:2px;accent-color:var(--red)">
            Je certifie être l'auteur original de cette ressource ou avoir le droit de la partager.
          </label>
        </div>
      </div>
      <div class="submit-btn-wrap">
        <button class="btn btn-primary" style="justify-content:center;padding:12px" onclick="submitResource()">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          Soumettre la ressource
        </button>
        <a href="index.html" class="btn btn-outline" style="justify-content:center">Annuler</a>
      </div>
    </div>
  </div>
</div>

<div id="toast-container"></div>
<footer class="footer" id="footer"></footer>

<script src="js/app.js"></script>
<script>
let submitState = { type: 'free', category: '', images: [], files: [], uploadedFiles: [], vipOnly: false };
let activeFileTab = 'link';

(async () => {
  await initAuth();
  await loadAppCategories();
  renderNavbar('');
  renderFooter();
  if (!App.user) {
    showToast('Connexion requise', 'error');
    setTimeout(() => window.location.href = 'index.html', 2000);
    return;
  }
  // Afficher le toggle VIP uniquement pour les admins/owner/dev
  if (roleLevel(App.user.role) >= 1) {
    const vipSection = document.getElementById('vipToggleSection');
    if (vipSection) vipSection.style.display = 'block';
  }
  buildCatGrid();
  addFile();
  renderImagesPreview();
})();

// FILE TABS
function switchFileTab(tab) {
  activeFileTab = tab;
  document.getElementById('panelLink').classList.toggle('active', tab === 'link');
  document.getElementById('panelUpload').classList.toggle('active', tab === 'upload');
  document.getElementById('tabLink').classList.toggle('active', tab === 'link');
  document.getElementById('tabUpload').classList.toggle('active', tab === 'upload');
}

// CATEGORY
function buildCatGrid() {
  document.getElementById('catGrid').innerHTML = App.categories.map(c =>
    `<button class="cat-btn" onclick="selectCat(this,'${c}')">${c}</button>`
  ).join('');
}
function selectCat(btn, cat) {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  submitState.category = cat;
}

// TYPE
function toggleVipOnly() {
  submitState.vipOnly = !submitState.vipOnly;
  const track = document.getElementById('vipToggleTrack');
  const thumb = document.getElementById('vipToggleThumb');
  if (submitState.vipOnly) {
    track.style.background = 'rgba(215,38,56,.35)';
    track.style.borderColor = 'var(--red-border)';
    thumb.style.transform = 'translateX(20px)';
    thumb.style.background = 'var(--red)';
  } else {
    track.style.background = 'rgba(255,255,255,.1)';
    track.style.borderColor = 'rgba(255,255,255,.15)';
    thumb.style.transform = 'translateX(0)';
    thumb.style.background = 'var(--text-dim)';
  }
}

function setType(t) {
  submitState.type = t;
  document.getElementById('btnFree').className = 'type-btn' + (t === 'free' ? ' sel-free' : '');
  document.getElementById('btnPaid').className = 'type-btn' + (t === 'paid' ? ' sel-paid' : '');
  document.getElementById('paidSection').style.display = t === 'paid' ? 'block' : 'none';
}

// LINKS
function addFile() {
  submitState.files.push({ id: Date.now(), url: '' });
  renderFileList();
}
function removeFile(id) {
  submitState.files = submitState.files.filter(f => f.id !== id);
  renderFileList();
}
function updateFile(id, url) {
  const f = submitState.files.find(x => x.id === id);
  if (f) f.url = url;
}
function renderFileList() {
  document.getElementById('fileList').innerHTML = submitState.files.map(f => `
    <div class="file-row">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="m10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
        <path d="m14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
      </svg>
      <input placeholder="Coller un lien de téléchargement..." value="${f.url}"
        oninput="updateFile(${f.id},this.value)" style="font-size:0.78rem">
      ${submitState.files.length > 1 ? `<button class="rm-file" onclick="removeFile(${f.id})">✕</button>` : ''}
    </div>
  `).join('');
  updateFileCount();
}
function updateFileCount() {
  const total = submitState.files.filter(f=>f.url.trim()).length + submitState.uploadedFiles.length;
  document.getElementById('fileCountLabel').textContent = `(${total})`;
}

// FILE UPLOAD (drag & drop)
function handleFileDrop(e, type) {
  e.preventDefault();
  document.getElementById(type === 'image' ? 'imgDropZone' : 'fileDropZone').classList.remove('dragover');
  const files = Array.from(e.dataTransfer.files);
  if (type === 'image') processImageFiles(files);
  else processUploadFiles(files);
}
function handleImageSelect(e) { processImageFiles(Array.from(e.target.files)); }
function handleFileSelect(e) { processUploadFiles(Array.from(e.target.files)); }

function processImageFiles(files) {
  const imageFiles = files.filter(f => f.type.startsWith('image/'));
  if (!imageFiles.length) return showToast('Fichiers image uniquement', 'error');
  imageFiles.forEach(file => {
    if (submitState.images.length >= 10) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      submitState.images.push(e.target.result);
      renderImagesPreview();
    };
    reader.readAsDataURL(file);
  });
}

function processUploadFiles(files) {
  files.forEach(file => {
    submitState.uploadedFiles.push({ id: Date.now() + Math.random(), name: file.name, size: file.size, file });
    renderUploadedFiles();
  });
  updateFileCount();
}
function removeUploadedFile(id) {
  submitState.uploadedFiles = submitState.uploadedFiles.filter(f => f.id !== id);
  renderUploadedFiles();
  updateFileCount();
}
function renderUploadedFiles() {
  document.getElementById('uploadedFileList').innerHTML = submitState.uploadedFiles.map(f => `
    <div class="uploaded-file-row">
      <div class="uploaded-file-info">
        <svg width="13" height="13" fill="none" stroke="var(--green)" stroke-width="2" viewBox="0 0 24 24" style="flex-shrink:0">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/>
        </svg>
        <span class="uploaded-file-name">${f.name}</span>
        <span class="uploaded-file-size">${(f.size/1024/1024).toFixed(1)}Mo</span>
      </div>
      <button class="rm-file" onclick="removeUploadedFile(${f.id})">✕</button>
    </div>
  `).join('');
}

// IMAGES
function addImgUrl() {
  const url = document.getElementById('imgUrlInput').value.trim();
  if (!url) return;
  if (submitState.images.length >= 10) return showToast('Maximum 10 images', 'error');
  submitState.images.push(url);
  document.getElementById('imgUrlInput').value = '';
  renderImagesPreview();
}
function removeImg(idx) { submitState.images.splice(idx, 1); renderImagesPreview(); }
function renderImagesPreview() {
  document.getElementById('imagesPreview').innerHTML = submitState.images.map((img, i) => `
    <div class="img-slot">
      <img src="${img}" alt="" onerror="this.parentElement.style.background='var(--bg4)'">
      <button class="rm-img" onclick="removeImg(${i})">✕</button>
    </div>
  `).join('');
  document.getElementById('imgCountLabel').textContent = `(${submitState.images.length}/10)`;
}

// SUBMIT
async function submitResource() {
  const title = document.getElementById('fTitle').value.trim();
  const description = document.getElementById('fDesc').value.trim();
  if (!title) return showToast('Titre requis', 'error');
  if (!description) return showToast('Description requise', 'error');
  if (!submitState.category) return showToast('Choisissez une catégorie', 'error');
  if (!document.getElementById('fAuthor').checked) return showToast('Confirmez être l\'auteur', 'error');

  const linkFiles = submitState.files.filter(f => f.url.trim()).map(f => ({ url: f.url.trim(), type: 'link' }));
  const uploadFiles = submitState.uploadedFiles.map(f => ({ url: f.name, type: 'upload', name: f.name }));
  const allFiles = [...linkFiles, ...uploadFiles];
  if (!allFiles.length) return showToast('Ajoutez au moins un fichier ou lien', 'error');

  if (submitState.type === 'paid') {
    if (!document.getElementById('fPurchaseUrl').value.trim()) return showToast('Lien d\'achat requis', 'error');
    if (!document.getElementById('fPrice').value) return showToast('Prix requis', 'error');
  }

  const body = {
    title, description,
    category: submitState.category,
    images: submitState.images,
    thumbnail: submitState.images[0] || null,
    files: allFiles,
    videoUrl: document.getElementById('fVideo').value.trim() || null,
    resourceType: submitState.type,
    vipOnly: submitState.vipOnly,
    price: submitState.type === 'paid' ? parseFloat(document.getElementById('fPrice').value) : 0,
    purchaseUrl: submitState.type === 'paid' ? document.getElementById('fPurchaseUrl').value.trim() : null,
  };

  try {
    await apiFetch('/resources', { method: 'POST', body: JSON.stringify(body) });
    showToast('Ressource soumise ! En attente de validation.', 'success');
    setTimeout(() => window.location.href = 'index.html', 2000);
  } catch (err) { showToast(err.message, 'error'); }
}
</script>
</body>
</html>
